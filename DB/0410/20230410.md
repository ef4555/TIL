# RDB(관계형 데이터베이스)
- 데이터를 테이블, 행, 열 등으로 나누어 구조화
- RDB의 모든 테이블에는 행에서 고유하게 식별 가능한 기본 키라는 속성이 있으며 외래 키를 사용하여 각 행에서 서로 다른 테이블간의 관계를 만드는데 사용 가능하다

- 테이블 관계 예시
  - 주문 데이터와 고객 데이터 테이블을 연결
  - 고객 정보의 기본 키인 고객 id 정보를 주문 데이터 테이블에 외래 키로 설정
  - 관계형 데이터베이스에서 한 테이블의 필드 중 다른 테이블의 행을 식별할 수 있는 키를 외래 키 라고 함
  - 두 테이블은 고객 id를 기반으로 연결되며 다양한 명령 처리 가능
    - 특정 날짜에 구매한 모든 고객정보 확인
    - 지난 달에 배송이 지연된 주문을 받은 고객 처리

## RDB에서 관계
- 1:1
  - 한 테이블의 레코드 하나가 다른 테이블의 레코드 단 한 개와 관련된 경우

- N:1
  - 한 테이블의 0개 이상의 레코드가 다른 테이블의 레코드 한 개와 관련된 경우
  - 기준 테이블에 따라 1:N 이라고도 함

- M:N
  - 한 테이블의 0개 이상의 레코드가 다른 테이블의 0개 이상의 레코드와 관련된 경우
  - 양쪽 모두에서 N:1관계를 가짐

## 외래 키
- 관계형 데이터베이스에서 다른 테이블의 행을 식별할 수 있는 키
- 참조**되는** 테이블의 기본 키를 가리킴
- 참조하는 테이블의 행 1개의 값은 참조되는 측 테이블의 행 값에 대응됨
  - 이 때문에 참조하는 테이블의 행에는, 참조되는 테이블에 나타나지 않는 값을 포함할 수 없음
- 참조하는 테이블 행 여러 개가, 참조되는 테이블의 동일한 행을 참조할 수 있음
  - 한 사람이 여러개의 주문을 할 수 있는게 예시

### ForeignKey arguments - on_delete
- 외래 키가 참조하는 객체가 사라졌을 때, 외래 키를 가진 객체를 어떻게 처리할 지를 정의
- 데이터 무결성을 위해서 매우 중요한 설정
- on_delete 옵션 값
  - CASCADE : 부모 객체(참조 된 객체)가 삭제 됐을 때, 이를 참조하는 객체
  - PROTECT, SET_NULL, SET_DEFAULT등 여러 옵션 값들이 존재
  - 수업에서는 CASCADE 값만 사용할 예정
  
### related manager
- related manager는 N:1, M:N 관계에서 사용 가능한 문맥
- Django는 모델 간 N:1, M:N 관계가 설정되면 역참조할 때에 사용할 수 있는 manager를 생성 
  - 우리가 이전에 모델 생성 시 objects라는 매니저를 통해 queryset api를 사용했던 것 처럼 related manager를 통해 query api를 사용할 수 있게 됨
- 지금은 N:1 관계에서의 related manager만을 학습할 것

### 역참조
- 나를 참조하는 테이블(나를 외래 키로 지정한)을 참조하는 것
- 즉, 본인을 외래 키로 참조 중인 다른 테이블에 접근하는 것
- N:1 관계에서는 1이 N을 참조하는 상황
  - 외래 키를 가지지 않은 1이 외래 키를 가진 N을 참조
- Article모델이 Comment 모델을 참조할 때
  - article.comment 형식으로는 댓글 객체를 참조 할 수 없음
    - Article 클래스에는 Comment 와의 어떤 관계도 작성되어 있지 않음
- 대신 django가 역참조 할 수 있는 commnet_set manager를 자동으로 생성해 article.comment_set 형태로 댓글 객체를 참조할 수 있음
- 반면 참조상황(Comment -> Article)에서는 실제 ForegnKey 클래스로 작성한 인스턴스가 Comment 클래스의 클래스 변수이기 때문에 commnet.article 형태로 작성 가능

### related_name
- ForeigKey 클래스의 선택 옵션
- 역참조 시 사용하는 매니저 이름(model_set manager)을 변경할 수 있음
- 작성 후, migration 과정이 필요
- 선택 옵션이지만 상황에 따라 반드시 작성해야 하는 경우가 생기기도 하는데 이는 추후 자연스럽게 만나볼 예정
- 작성 후 다시 원래 코드로 복구(나중에 M:N 관계 학습 시 자세히 설명)

### 댓글 기능 구현
#### create
1. 사용자로부터 댓글 데이터를 입력 받기 위한 CommentForm 작성(외래 키 필드를 제외)
2. detail 페이지에서 CommentForm 출력(view함수)
3. detail 페이지에서 CommentForm 출력
4. 출력에서 제외된 외래 키는 url에서 받아온다(variable routing)
5. save(commit = False)
   1. 아직 데이터베이스에 저장되지 않은 인스턴스를 반환
   2. 저장하기 전에 객체에 대한 사용자 지정 처리를 수행할 때 유용하게 사용
#### read
1. 특정 article에 있는 모든 댓글을 가져와서 context에 추가
   1. comments = article.commnet_set_all()

### Django에서 User 모델을 참조하는 방법
1. settings.AUTH_USER_MODEL
   1. 반환 값 : 'accounts.User' (문자열)
   2. User 모델에 대한 외래 키 또는 M:N 관계를 정의할 때 사용
   3. **models.py의 모델 필드에서 User 모델을 참조할 때 사용***

2. get_user_model()
   1. 반환 값 : User Object(객체)
   2. 현재 활성화(active) 된 User 모델을 반환
   3. 커스터마이징 한 User 모델이 있을 경우는 Custom User 모델, 그렇지 않으면 User를 반환
   4. **models.py가 아닌 다른 모든 곳에서 유저 모델을 참조할 때 사용**

### 모델 관계 설정
1. Article 모델에 User 모델을 참조하는 외래 키 작성
2. 새 칼럼을 추가했으므로 기존 데이터 어떻게 할 것인지 설정


# 게시글을 작성한 유저만 지울수 있게 하는 법
- 교재 참조